generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ProductCategory {
  id       Int               @id @default(autoincrement())
  name     String
  parentId Int?
  products Product[]
  parent   ProductCategory?  @relation("CategoryParent", fields: [parentId], references: [id])
  children ProductCategory[] @relation("CategoryParent")
}

model Product {
  id             Int              @id @default(autoincrement())
  name           String
  sku            String?          @unique
  type           String           @default("service")
  basePrice      Float
  categoryId     Int?
  description    String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  weight         Decimal?         @default(0) @db.Decimal(12, 2)
  bigClientPrice Decimal?         @default(0) @db.Decimal(12, 2)
  serviceOptions Json?            @default("{\"dryWash\": false, \"ironing\": false, \"wetWash\": false, \"externalService\": false}")
  orderLines     OrderLine[]
  category       ProductCategory? @relation(fields: [categoryId], references: [id])
  variants       ProductVariant[]
}

model ProductVariant {
  id              Int         @id @default(autoincrement())
  productId       Int
  name            String
  attributeValues Json?
  priceModifier   Float       @default(0)
  orderLines      OrderLine[]
  product         Product     @relation(fields: [productId], references: [id])
}

model Order {
  id                    Int             @id @default(autoincrement())
  orderNum              String          @unique
  clientId              Int?
  total                 Float
  paid                  Boolean         @default(false)
  paymentMethod         String?
  observaciones         String?
  fechaLimite           DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  status                String?         @default("pending")
  workerId              Int?
  observacionesInternas String?
  CashMovement          CashMovement[]
  notification          Notification[]
  client                User?           @relation("client_orders", fields: [clientId], references: [id])
  lines                 OrderLine[]
  invoiceTickets        invoiceTickets?
}

model OrderLine {
  id         Int             @id @default(autoincrement())
  orderId    Int
  productId  Int
  variantId  Int?
  quantity   Int
  unitPrice  Float
  totalPrice Float
  notes      String?
  discount   Float?          @default(0)
  order      Order           @relation(fields: [orderId], references: [id])
  product    Product         @relation(fields: [productId], references: [id])
  variant    ProductVariant? @relation(fields: [variantId], references: [id])
}

model User {
  id                 Int            @id @default(autoincrement())
  firstName          String
  lastName           String
  email              String?        @unique
  password           String?
  role               String         @default("cashier")
  phone              String?        @unique
  isActive           Boolean        @default(true)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  codigopostal       String?        @db.VarChar
  denominacionsocial String?        @db.VarChar
  direccion          String?        @db.VarChar
  localidad          String?        @db.VarChar
  nif                String?        @db.VarChar
  pais               String?        @db.VarChar
  provincia          String?        @db.VarChar
  tipopersona        String?        @db.VarChar
  isbigclient        Boolean        @default(false)
  discount           Float          @default(0)
  cashClosures       CashClosure[]
  personMovements    CashMovement[] @relation("person_movements")
  cashMovements      CashMovement[] @relation("user_movements")
  orders             Order[]        @relation("client_orders")
  invoices           invoices[]
}

model Notification {
  id            Int      @id @default(autoincrement())
  type          String
  recipient     String
  content       String
  status        String
  sentAt        DateTime @default(now())
  orderid       Int?
  statusCode    Int?
  subid         String?  @db.VarChar(64)
  statusMessage String?  @db.VarChar(255)
  order         Order?   @relation(fields: [orderid], references: [id], map: "Notification_taskId_fkey")
}

model CashClosure {
  id             Int            @id @default(autoincrement())
  openedat       DateTime?      @db.Timestamptz(6)
  closedat       DateTime       @default(now()) @db.Timestamptz(6)
  openingamount  Decimal        @default(0) @db.Decimal(12, 2)
  expectedamount Decimal        @db.Decimal(12, 2)
  countedamount  Decimal        @db.Decimal(12, 2)
  diff           Decimal        @db.Decimal(12, 2)
  userId         Int
  notes          String?
  user           User           @relation(fields: [userId], references: [id])
  movements      CashMovement[]
}

model CashMovement {
  id           Int              @id @default(autoincrement())
  type         CashMovementType
  amount       Decimal          @db.Decimal(12, 2)
  movementat   DateTime         @default(now()) @db.Timestamptz(6)
  orderid      Int?
  userid       Int
  note         String?
  closureId    Int?
  personUserId Int?
  closure      CashClosure?     @relation(fields: [closureId], references: [id])
  order        Order?           @relation(fields: [orderid], references: [id])
  personUser   User?            @relation("person_movements", fields: [personUserId], references: [id])
  user         User             @relation("user_movements", fields: [userid], references: [id])
}

model invoiceLines {
  id          BigInt   @id @default(autoincrement())
  invoiceId   BigInt
  position    Int
  description String
  quantity    Decimal  @default(1) @db.Decimal(12, 3)
  unitPrice   Decimal  @db.Decimal(12, 4)
  discountPct Decimal  @default(0) @db.Decimal(5, 2)
  taxRatePct  Decimal  @db.Decimal(5, 2)
  netAmount   Decimal  @db.Decimal(12, 2)
  taxAmount   Decimal  @db.Decimal(12, 2)
  grossAmount Decimal  @db.Decimal(12, 2)
  invoices    invoices @relation(fields: [invoiceId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model invoiceTickets {
  invoiceId BigInt
  ticketId  Int      @unique(map: "invoicetickets_pk")
  invoices  invoices @relation(fields: [invoiceId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  order     Order    @relation(fields: [ticketId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@id([invoiceId, ticketId])
  @@index([ticketId], map: "idx_invoiceTickets_ticketId")
}

model invoices {
  id                 BigInt           @id @default(autoincrement())
  number             String?          @db.VarChar
  invoiceYear        Int
  issuedAt           DateTime         @db.Timestamptz(6)
  operationDate      DateTime?        @db.Date
  currency           String           @default("EUR") @db.Char(3)
  sellerName         String
  sellerTaxId        String
  sellerAddress      String
  totalNet           Decimal          @default(0) @db.Decimal(12, 2)
  totalTax           Decimal          @default(0) @db.Decimal(12, 2)
  totalGross         Decimal          @default(0) @db.Decimal(12, 2)
  docStatus          String           @default("draft")
  paymentStatus      String           @default("unpaid")
  isRectifying       Boolean          @default(false)
  rectifiesInvoiceId BigInt?
  notes              String?
  createdAt          DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime         @default(now()) @db.Timestamptz(6)
  clientId           Int?
  paid               Boolean?
  type               String?          @db.Char(1)
  invoiceLines       invoiceLines[]
  invoiceTickets     invoiceTickets[]
  User               User?            @relation(fields: [clientId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_invoices_client")
  invoices           invoices?        @relation("invoicesToinvoices", fields: [rectifiesInvoiceId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_invoices     invoices[]       @relation("invoicesToinvoices")
}

enum CashMovementType {
  sale_cash_in
  withdrawal
  deposit
  refund_cash_out
  opening
  correction
}
