datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model ProductCategory {
  id       Int               @id @default(autoincrement())
  name     String
  parentId Int?
  parent   ProductCategory?  @relation("CategoryParent", fields: [parentId], references: [id])
  children ProductCategory[] @relation("CategoryParent")
  products Product[] // relaci贸n opuesta
}

model Product {
  id          Int              @id @default(autoincrement())
  name        String
  sku         String?          @unique
  type        String           @default("service") // service/item
  basePrice   Float
  category    ProductCategory? @relation(fields: [categoryId], references: [id])
  categoryId  Int?
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  variants    ProductVariant[]
  orderLines  OrderLine[] // relaci贸n opuesta
}

model ProductVariant {
  id              Int         @id @default(autoincrement())
  product         Product     @relation(fields: [productId], references: [id])
  productId       Int
  name            String
  attributeValues Json?
  priceModifier   Float       @default(0)
  orderLines      OrderLine[] // relaci贸n opuesta
}

model Order {
  id            Int      @id @default(autoincrement())
  orderNum      String   @unique
  clientId      Int?
  total         Float
  paid          Boolean  @default(false)
  paymentMethod String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  client User?       @relation("client_orders", fields: [clientId], references: [id])
  lines  OrderLine[]
  tasks  Task[]
}

model OrderLine {
  id         Int             @id @default(autoincrement())
  order      Order           @relation(fields: [orderId], references: [id])
  orderId    Int
  product    Product         @relation(fields: [productId], references: [id])
  productId  Int
  variant    ProductVariant? @relation(fields: [variantId], references: [id])
  variantId  Int?
  quantity   Int
  unitPrice  Float
  totalPrice Float
  notes      String?
}

model User {
  id        Int      @id @default(autoincrement())
  firstName String
  lastName  String
  email     String?  @unique
  password  String? // null para clientes sin login
  role      String   @default("cashier") // admin, cashier, worker, customer, etc.
  phone     String?  @unique // validado en l贸gica para clientes
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tasksAssigned  Task[]   @relation("WorkerTasks")   // tareas donde es trabajador
  orders Order[] @relation("client_orders", fields: [], references: [])
}

model Task {
  id           Int        @id @default(autoincrement())
  name         String
  description  String?
  state        String     // 'pending', 'ready', 'collected', etc.
  orderId      Int?
  order        Order?     @relation(fields: [orderId], references: [id])
  workerId     Int?
  worker       User?      @relation("WorkerTasks", fields: [workerId], references: [id])
  assignedAt   DateTime?
  completedAt  DateTime?
  collectedAt  DateTime?
  notifications Notification[]
}

model Notification {
  id        Int      @id @default(autoincrement())
  task      Task     @relation(fields: [taskId], references: [id])
  taskId    Int
  type      String // sms, whatsapp, email
  recipient String
  content   String
  status    String // sent, failed
  sentAt    DateTime @default(now())
}
